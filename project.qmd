---
title: "new506"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(haven)
library(survey)
path <- "/Users/xinxiang/Desktop/GSS_stata/gss7224_r2.dta"
raw  <- haven::read_dta(path)
pick <- function(df, x) x[x %in% names(df)][1]
#for all possible column name
yrv  <- pick(raw, c("year","YEAR"))
hapv <- pick(raw, c("happy","HAPPY"))
agev <- pick(raw, c("age","AGE"))
wrkv <- pick(raw, c("wrkstat","WRKSTAT"))
incv <- pick(raw, c("realinc","REALINC","coninc","CONINC"))
wtv  <- pick(raw, c("wtssall","WTSSALL","wtss","WTSS"))
# clean
dat <- raw %>%
  transmute(
    yr  = as.integer(.data[[yrv]]),
    y   = as.integer(.data[[hapv]]),
    age = as.numeric(.data[[agev]]),
    wrk = as.integer(.data[[wrkv]]),
    inc = as.numeric(.data[[incv]]),
    wt = if (!is.na(wtv)) as.numeric(.data[[wtv]]) else 1
  filter(yr %in% c(2018, 2021)) %>%
  mutate( post = if_else(yr == 2021, 1, 0),
    y = na_if(y, 0),
    y = na_if(y, 8),
    y = na_if(y, 9),
    happy_bin = case_when(
      y %in% c(1, 2) ~ 1,   
      y == 3 ~ 0,           
      TRUE ~ NA_real_ ),
    age = if_else(age < 18 | age > 89, NA_real_, age),
    inc = if_else(!is.finite(inc) | inc <= 0, NA_real_, inc),
    linc = log(inc),
    wrk = na_if(wrk, 0),
    wrk = na_if(wrk, 8),
    wrk = na_if(wrk, 9),
    wrk3 = case_when(
      wrk %in% c(1, 2) ~ "Employed", wrk %in% c(3, 4, 5) ~ "Unemployed / Temp not working",
      wrk %in% c(6, 7) ~ "Not in labor force", TRUE ~ NA_character_ ),
    wrk3 = factor(wrk3),
    wt = if_else(!is.finite(wt) | wt <= 0, 1, wt) ) %>%
  drop_na(happy_bin, post, age, linc, wrk3)
with(dat, table(post, yr))
dsgn <- svydesign(
  ids = ~1,
  weights = ~wt,
  data = dat )
mod <- svyglm(
  happy_bin ~ post + linc + age + wrk3,
  design = dsgn,
  family = quasibinomial() )
summary(mod)

co <- coef(mod)["post"]
se <- sqrt(vcov(mod)["post","post"])
OR <- exp(co)
CI <- exp(co + c(-1,1) * 1.96 * se)
cat(
  "\nPost-pandemic effect (2021 vs 2018):",
  "\nOR =", round(OR, 3),
  "\n95% CI =", paste0("(", round(CI[1], 3), ", ", round(CI[2], 3), ")"),
  "\nInterpretation: OR < 1 implies lower probability of being happy in 2021.\n")

```

```{r}
#  Figure 1: Weighted happiness distribution 2018 vs 2021
dir.create("output", showWarnings = FALSE)
fig_dat <- prop.table(
  svytable(~ post + happy_bin, dsgn),
  margin = 1
) |>
  as.data.frame() |>
  transmute(
    period  = if_else(post == 0, "2018 ", "2021"),
    outcome = if_else(happy_bin == 1, "Happy", "Not happy"),
    p = Freq )
fig1 <- ggplot(fig_dat, aes(x = period, y = p, fill = outcome)) +
  geom_col(position = "fill", width = 0.62) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = NULL,
    y = "Weighted share",
    fill = NULL,
    title = "Weighted happiness distribution"  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")
print(fig1)
ggsave(
  filename = "output/Figure1_weighted_happiness_2018_2021.png",
  plot = fig1,
  width = 6.5, height = 4.2, dpi = 300 )
# Figure 2: Post effect as Odds Ratio + 95% CI
fig2_dat <- tibble(
  term = "Post 2021 vs 2018",
  OR = OR,
  lo = CI[1],
  hi = CI[2])
fig2 <- ggplot(fig2_dat, aes(x = term, y = OR)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lo, ymax = hi), width = 0.12) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(
    x = NULL,
    y = "Odds Ratio (95% CI)",
    title = "Estimated post-pandemic effect (survey-weighted logit)"  ) +
  theme_minimal(base_size = 12)
print(fig2)
ggsave(
  filename = "output/Figure2_post_OR_2018_2021.png",
  plot = fig2,
  width = 6.5, height = 3.6, dpi = 300
)

#  Table : Regression results 
tab1 <- broom::tidy(mod) |>
  filter(term != "(Intercept)") |>
  transmute(
    Variable = case_when(
      term == "post" ~ "Post (2021 vs 2018)",
      term == "linc" ~ "Log income",
      term == "age"  ~ "Age",
      term == "wrk3Not in labor force" ~ "Not in labor force",
      term == "wrk3Unemployed / Temp not working" ~ "Unemployed / Temp not working",
      TRUE ~ term
    ),
    `Odds Ratio` = exp(estimate),
    `95% CI (lo)` = exp(estimate - 1.96 * std.error),
    `95% CI (hi)` = exp(estimate + 1.96 * std.error),
    `p-value` = p.value
  ) |>
  mutate(
    `Odds Ratio` = round(`Odds Ratio`, 3),
    `95% CI (lo)` = round(`95% CI (lo)`, 3),
    `95% CI (hi)` = round(`95% CI (hi)`, 3),
    `p-value` = if_else(`p-value` < 0.001, "<0.001", sprintf("%.3f", `p-value`))
  )

knitr::kable(
  tab1,
  align = "lrrrr"
)

```
